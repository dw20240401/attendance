<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>å‹¤æ€ ä¸€è¦§</title>
    <link rel="stylesheet" type="text/css" href="index.css">
  </head>
  <body>
    <div id="wrapper">
      <main>
        <div>
          <h3 id="NowDateArea">    /  /  ()</h3>ã€€
          <button type="button" id="reloadBtn">ğŸ”ƒ</button>
        </div>
        <div id="wrapper">
          <table id="tbl" border="1">
            <thead>
              <tr>
                <!-- <th></th> -->
                <th>éƒ¨é–€å</th>
                <th>ç¤¾å“¡å</th>
                <th>æœ¬æ—¥äºˆå®š</th>
                <th>å‹¤å‹™å ´æ‰€</th>
                <th>å‹¤å‹™é–‹å§‹</th>
                <th>å‹¤å‹™çµ‚äº†</th>
                <th>æ˜æ—¥/æ¥é€±</th>
              </tr>
            </thead>
          </table>
        </div>
      </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore-compat.js"></script>
    <script>
      // FireStoreè¨­å®š
      const firebaseConfig = {
        apiKey: "AIzaSyCL5ftfrlwsjTa4O-DjPqLtJA-t0JHDLoU",
        authDomain: "attendance-3cf4f.firebaseapp.com",
        projectId: "attendance-3cf4f",
        storageBucket: "attendance-3cf4f.appspot.com",
        messagingSenderId: "442106731625",
        appId: "1:442106731625:web:a3c7b0f4521bfd88c096f8",
        measurementId: "G-1PN91D78KW"     
      };
      const app = firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      // ç¾åœ¨æ—¥æ™‚ã‚»ãƒƒãƒˆ
      function setNowDataTime() {
        // ç¾åœ¨æ—¥æ™‚
        var dateTime=new Date();

        // ç¾åœ¨æ—¥ä»˜
        var year = dateTime.getFullYear().toString().padStart(4, "0");
        var month = (dateTime.getMonth()+1).toString().padStart(2, "0");
        var day = dateTime.getDate().toString().padStart(2, "0");
        var week = dateTime.getDay();
        var week_ja= new Array("æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ");
        var dispDate = year + "/" + month + "/" + day + "(" + week_ja[week] + ")";
        document.getElementById("NowDateArea").innerHTML = dispDate;

        // ç¾åœ¨æ™‚åˆ»
        var nowHour = dateTime.getHours().toString().padStart(2, "0");
        var nowMin  = dateTime.getMinutes().toString().padStart(2, "0");
        var nowSec  = dateTime.getSeconds().toString().padStart(2, "0");
        var time = nowHour + ":" + nowMin + ":" + nowSec;
        // document.getElementById("NowTimeArea").innerHTML = time;
      }
      setInterval('setNowDataTime()',1000);

      function getAttendance() {
        // ç¾åœ¨æ—¥æ™‚
        var dateTime=new Date();

        // ç¾åœ¨æ—¥ä»˜
        var year = dateTime.getFullYear().toString().padStart(4, "0");
        var month = (dateTime.getMonth()+1).toString().padStart(2, "0");
        var day = dateTime.getDate().toString().padStart(2, "0");
        var date = year + month + day;

        // ãƒ¦ãƒ¼ã‚¶ä¸€è¦§ 
        var divisionDocRef = db.collection("users2");
        divisionDocRef.get().then((divisionDocs) => {
        // divisionDocRef.orderBy(firebase.firestore.FieldPath.documentId(), "desc").get().then((docs) => {
          divisionDocs.forEach(divisionDoc => {
            // éƒ¨é–€æ¯ã®ãƒ¡ãƒ³ãƒãƒ¼ã®å‹¤æ€ æƒ…å ±å–å¾—
            var membersDocRef = db.collection("users2").doc(divisionDoc.id).collection("members");
            membersDocRef.orderBy("order").get().then((membersDocs) => {
              membersDocs.forEach(membersDoc => {
                var uid = membersDoc.id
                var user = membersDoc.data();
                var tbl = document.getElementById("tbl");
                var tr = document.createElement("tr");
                var td1 = document.createElement('td');
                var td2 = document.createElement('td');
                var td3 = document.createElement('td');
                var td4 = document.createElement('td');
                var td5 = document.createElement('td');
                var td6 = document.createElement('td');
                var td7 = document.createElement('td');
                // å„ãƒ¦ãƒ¼ã‚¶ã®å‹¤æ€ æƒ…å ±å–å¾—ï¼ˆæ–°ï¼‰
                var attendanceDocRef = db.collection("attendance2").doc(uid);
                attendanceDocRef.get().then((attendanceDoc) => {
                  if (attendanceDoc.exists) {
                    // ä»Šæ—¥ã€æ˜æ—¥ã®çµ‚æ—¥äºˆå®š
                    td3.textContent = attendanceDoc.data().today;
                    td7.textContent = attendanceDoc.data().tomorrow;
                  } else {
                    td3.textContent = "";
                    td7.textContent = "";
                  }
                  var timerecordDocRef = db.collection("attendance2").doc(uid).collection("timerecord").doc(date);
                  timerecordDocRef.get().then((timerecordDoc) => {
                    td5.textContent = "--:--:--";
                    td6.textContent = "--:--:--";
                    if(timerecordDoc.exists) {
                      var attendance = timerecordDoc.data();
                      // å‹¤å‹™ä¸­ã‹
                      if(attendance.start_time && !attendance.end_time) {
                        td2.style.color = "#ffffff";
                        td2.style.fontWeight = "bold";
                        td2.style.backgroundColor = "#009900";
                        td5.textContent = attendance.start_time;
                        // td6.textContent = "--:--:--";
                      } else if(attendance.end_time) {
                        td2.style.color = "#ffffff";
                        td2.style.fontWeight = "bold";
                        td2.style.backgroundColor = "#FF6600"
                        td5.textContent = attendance.start_time;
                        td6.textContent = attendance.end_time;
                      } else {
                        td2.style.color = "#ffffff";
                        td2.style.fontWeight = "bold";
                        td2.style.backgroundColor = "#FF6600"
                      }
                      td1.textContent = user.division_name;
                      td2.textContent = user.user_name;
                      td4.textContent = attendance.work_space;
                      tr.appendChild(td1);
                      tr.appendChild(td2);
                      tr.appendChild(td3);
                      tr.appendChild(td4);
                      tr.appendChild(td5);
                      tr.appendChild(td6);
                      tr.appendChild(td7);
                      tbl.appendChild(tr);
                    } else {
                      td1.textContent = user.division_name;
                      td2.textContent = user.user_name;
                      td2.style.color = "#ffffff";
                      td2.style.fontWeight = "bold";
                      td2.style.backgroundColor = "#FF6600"
                      td4.textContent = "";
                      tr.appendChild(td1);
                      tr.appendChild(td2);
                      tr.appendChild(td3);
                      tr.appendChild(td4);
                      tr.appendChild(td5);
                      tr.appendChild(td6);
                      tr.appendChild(td7);
                      tbl.appendChild(tr);
                    }
                  }).catch((error) => {
                    console.log("å‹¤æ€ æƒ…å ±å–å¾—å¤±æ•—", error);
                    alert("ãƒ¦ãƒ¼ã‚¶ãƒã‚¹ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                  });
                }).catch((error) => {
                  console.log("å‹¤æ€ æƒ…å ±å–å¾—å¤±æ•—", error);
                  alert("ãƒ¦ãƒ¼ã‚¶ãƒã‚¹ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                });

                // å„ãƒ¦ãƒ¼ã‚¶ã®å‹¤æ€ æƒ…å ±å–å¾—
                // var attendanceDocRef = db.collection("attendance").doc(date).collection("users").doc(uid);
                // attendanceDocRef.get().then((doc2) => {
                //   td5.textContent = "--:--:--";
                //   td6.textContent = "--:--:--";
                //   if(doc2.exists) {
                //     var attendance = doc2.data();
                //     // å‹¤å‹™ä¸­ã‹
                //     if(attendance.start_time && !attendance.end_time) {
                //       td2.style.color = "#ffffff";
                //       td2.style.fontWeight = "bold";
                //       td2.style.backgroundColor = "#009900";
                //       td5.textContent = attendance.start_time;
                //       // td6.textContent = "--:--:--";
                //     } else if(attendance.end_time) {
                //       td2.style.color = "#ffffff";
                //       td2.style.fontWeight = "bold";
                //       td2.style.backgroundColor = "#FF6600"
                //       td5.textContent = attendance.start_time;
                //       td6.textContent = attendance.end_time;
                //     } else {
                //       td2.style.color = "#ffffff";
                //       td2.style.fontWeight = "bold";
                //       td2.style.backgroundColor = "#FF6600"
                //     }
                //     td1.textContent = user.division_name;
                //     td2.textContent = user.user_name;
                //     td3.textContent = attendance.today;
                //     td4.textContent = attendance.work_space;
                //     // td5.textContent = attendance.start_time;
                //     td7.textContent = attendance.tomorrow;
                //     tr.appendChild(td1);
                //     tr.appendChild(td2);
                //     tr.appendChild(td3);
                //     tr.appendChild(td4);
                //     tr.appendChild(td5);
                //     tr.appendChild(td6);
                //     tr.appendChild(td7);
                //     tbl.appendChild(tr);
                //   } else {
                //     td1.textContent = user.division_name;
                //     td2.textContent = user.user_name;
                //     td2.style.color = "#ffffff";
                //     td2.style.fontWeight = "bold";
                //     td2.style.backgroundColor = "#FF6600"
                //     td4.textContent = "";
                //     // td5.textContent = "--:--:--";
                //     // td6.textContent = "--:--:--";
                //     tr.appendChild(td1);
                //     tr.appendChild(td2);
                //     tr.appendChild(td3);
                //     tr.appendChild(td4);
                //     tr.appendChild(td5);
                //     tr.appendChild(td6);
                //     tr.appendChild(td7);
                //     tbl.appendChild(tr);
                //   }
                // }).catch((error) => {
                //   console.log("å‹¤æ€ æƒ…å ±å–å¾—å¤±æ•—", error);
                //   alert("ãƒ¦ãƒ¼ã‚¶ãƒã‚¹ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                // });
              });
            }).catch((error) => {
              console.log("Firestore ãƒ¦ãƒ¼ã‚¶ãƒã‚¹ã‚¿å–å¾—å¤±æ•—", error);
              alert("ãƒ¦ãƒ¼ã‚¶ãƒã‚¹ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            });
          });
        }).catch((error) => {
            console.log("Firestore ãƒ¦ãƒ¼ã‚¶ãƒã‚¹ã‚¿å–å¾—å¤±æ•—", error);
            alert("ãƒ¦ãƒ¼ã‚¶ãƒã‚¹ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        });
      }
      getAttendance();
      // setInterval('getAttendance()',1000);

      // å†èª­è¾¼ãƒœã‚¿ãƒ³æŠ¼ä¸‹
      document.querySelector('#reloadBtn').addEventListener('click', function() {
        window.location.reload();
      });

    </script>
  </body>
</html>